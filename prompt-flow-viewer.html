<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prompt Flow Viewer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap');

    :root {
      --bg-canvas: #0a0a0f;
      --bg-node: #13131a;
      --bg-node-hover: #1a1a25;
      --bg-sidebar: #101018;
      --bg-prompt: #0d0d14;
      --border: #252530;
      --border-hover: #3a3a50;
      --text-primary: #e8e8f0;
      --text-secondary: #7a7a90;
      --text-dim: #50506a;
      --accent-blue: #4a7dff;
      --accent-green: #34d399;
      --accent-orange: #f59e0b;
      --accent-red: #ef4444;
      --accent-purple: #a78bfa;
      --accent-cyan: #22d3ee;
      --node-shadow: 0 4px 24px rgba(0,0,0,0.5);
      --node-shadow-active: 0 8px 40px rgba(74,125,255,0.15);
      --grid-color: #16161f;
      --edge-color: #2a2a40;
      --edge-active: #4a7dff;
    }

    [data-theme="light"] {
      --bg-canvas: #f0f2f5;
      --bg-node: #ffffff;
      --bg-node-hover: #f8f9fb;
      --bg-sidebar: #f6f7f9;
      --bg-prompt: #f0f1f4;
      --border: #d8dce3;
      --border-hover: #b0b8c4;
      --text-primary: #1a1d24;
      --text-secondary: #5a6170;
      --text-dim: #8a90a0;
      --accent-blue: #2563eb;
      --accent-green: #059669;
      --accent-orange: #d97706;
      --accent-red: #dc2626;
      --accent-purple: #7c3aed;
      --accent-cyan: #0891b2;
      --node-shadow: 0 2px 12px rgba(0,0,0,0.08);
      --node-shadow-active: 0 4px 24px rgba(37,99,235,0.12);
      --grid-color: #e4e7ec;
      --edge-color: #c4cad4;
      --edge-active: #2563eb;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Space Grotesk', sans-serif;
      background: var(--bg-canvas);
      color: var(--text-primary);
      overflow: hidden;
      height: 100vh;
      width: 100vw;
    }

    .app {
      display: flex;
      height: 100vh;
    }

    /* ═══ CANVAS ═══ */
    .canvas-wrap {
      flex: 1;
      position: relative;
      overflow: hidden;
      cursor: grab;
    }

    .canvas-wrap.grabbing { cursor: grabbing; }

    .canvas {
      position: absolute;
      top: 0;
      left: 0;
      transform-origin: 0 0;
    }

    .canvas-grid {
      position: absolute;
      top: -5000px;
      left: -5000px;
      width: 10000px;
      height: 10000px;
      background-image:
        radial-gradient(circle, var(--grid-color) 1px, transparent 1px);
      background-size: 30px 30px;
      pointer-events: none;
    }

    /* ═══ EDGES (SVG) ═══ */
    .edges-svg {
      position: absolute;
      top: -5000px;
      left: -5000px;
      width: 10000px;
      height: 10000px;
      pointer-events: none;
    }

    .edge-path {
      fill: none;
      stroke: var(--edge-color);
      stroke-width: 2;
      transition: stroke 0.3s, stroke-width 0.3s;
    }

    .edge-path.active {
      stroke: var(--edge-active);
      stroke-width: 3;
      filter: drop-shadow(0 0 6px rgba(74,125,255,0.4));
    }

    .edge-label {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      fill: var(--text-dim);
      pointer-events: none;
      paint-order: stroke;
      stroke: var(--bg-canvas);
      stroke-width: 3px;
    }

    .edge-label.active {
      fill: var(--accent-blue);
    }

    /* ═══ NODES ═══ */
    .node {
      position: absolute;
      width: 240px;
      background: var(--bg-node);
      border: 1px solid var(--border);
      border-radius: 12px;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
      box-shadow: var(--node-shadow);
      user-select: none;
    }

    .node:hover {
      border-color: var(--border-hover);
      background: var(--bg-node-hover);
      transform: translateY(-2px);
    }

    .node.selected {
      border-color: var(--accent-blue);
      box-shadow: var(--node-shadow-active);
    }

    .node-header {
      padding: 12px 14px 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid var(--border);
    }

    .node-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      flex-shrink: 0;
      font-weight: 600;
    }

    .node-icon.llm { background: rgba(74,125,255,0.15); color: var(--accent-blue); }
    .node-icon.transform { background: rgba(167,139,250,0.15); color: var(--accent-purple); }
    .node-icon.web { background: rgba(34,211,238,0.15); color: var(--accent-cyan); }
    .node-icon.input { background: rgba(52,211,153,0.15); color: var(--accent-green); }
    .node-icon.router { background: rgba(245,158,11,0.15); color: var(--accent-orange); }
    .node-icon.conditional { background: rgba(239,68,68,0.15); color: var(--accent-red); }

    .node-title {
      font-size: 13px;
      font-weight: 600;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .node-body {
      padding: 10px 14px;
    }

    .node-model {
      font-family: 'IBM Plex Mono', monospace;
      font-size: 10px;
      color: var(--text-dim);
      margin-bottom: 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .node-desc {
      font-size: 11px;
      color: var(--text-secondary);
      line-height: 1.5;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .node-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-top: 6px;
    }

    .badge-parallel { background: rgba(245,158,11,0.15); color: var(--accent-orange); }
    .badge-sequential { background: rgba(74,125,255,0.1); color: var(--accent-blue); }
    .badge-manual { background: rgba(239,68,68,0.15); color: var(--accent-red); }

    /* ═══ CONNECTORS ═══ */
    .node-connector {
      position: absolute;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--border);
      border: 2px solid var(--bg-node);
    }

    .node-connector.input-conn {
      left: -5px;
      top: 50%;
      transform: translateY(-50%);
    }

    .node-connector.output-conn {
      right: -5px;
      top: 50%;
      transform: translateY(-50%);
    }

    .node.selected .node-connector {
      background: var(--accent-blue);
    }

    /* ═══ SIDEBAR ═══ */
    .sidebar {
      width: 420px;
      background: var(--bg-sidebar);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: width 0.3s;
      overflow: hidden;
    }

    .sidebar.collapsed {
      width: 0;
      border-left: none;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: 700;
    }

    .sidebar-close {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .sidebar-close:hover { background: var(--bg-node); color: var(--text-primary); }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .sidebar-content::-webkit-scrollbar { width: 4px; }
    .sidebar-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .detail-section {
      margin-bottom: 20px;
    }

    .detail-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    .detail-value {
      font-size: 13px;
      color: var(--text-primary);
      line-height: 1.6;
    }

    .detail-models {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .model-tag {
      padding: 4px 10px;
      border-radius: 6px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 11px;
      background: rgba(74,125,255,0.1);
      color: var(--accent-blue);
      border: 1px solid rgba(74,125,255,0.2);
    }

    .prompt-block {
      background: var(--bg-prompt);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 12px;
      line-height: 1.7;
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 400px;
      overflow-y: auto;
      position: relative;
    }

    .prompt-block::-webkit-scrollbar { width: 4px; }
    .prompt-block::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .prompt-var {
      color: var(--accent-orange);
      font-weight: 500;
    }

    .io-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .io-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .io-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .io-dot.in { background: var(--accent-green); }
    .io-dot.out { background: var(--accent-orange); }

    .copy-prompt-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      padding: 4px 10px;
      border-radius: 4px;
      border: 1px solid var(--border);
      background: var(--bg-node);
      color: var(--text-dim);
      font-size: 10px;
      cursor: pointer;
      font-family: 'Space Grotesk', sans-serif;
    }

    .copy-prompt-btn:hover { color: var(--text-primary); background: var(--bg-node-hover); }

    /* ═══ TOOLBAR ═══ */
    .toolbar {
      position: absolute;
      top: 16px;
      left: 16px;
      display: flex;
      gap: 8px;
      z-index: 10;
    }

    .toolbar-btn {
      padding: 8px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-node);
      color: var(--text-secondary);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s;
    }

    .toolbar-btn:hover { background: var(--bg-node-hover); color: var(--text-primary); border-color: var(--border-hover); }

    .theme-toggle {
      width: 44px;
      height: 24px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg-node);
      cursor: pointer;
      position: relative;
      transition: all 0.3s;
      padding: 0;
    }

    .theme-toggle::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      background: var(--accent-blue);
      transition: transform 0.3s;
    }

    [data-theme="light"] .theme-toggle::after {
      transform: translateX(20px);
      background: var(--accent-orange);
    }

    .project-info {
      position: absolute;
      top: 16px;
      right: 440px;
      background: var(--bg-node);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 16px;
      z-index: 10;
      transition: right 0.3s;
    }

    .project-info.sidebar-closed { right: 16px; }

    .project-name {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .project-stats {
      font-size: 11px;
      color: var(--text-dim);
    }

    /* ═══ MINIMAP ═══ */
    .minimap {
      position: absolute;
      bottom: 16px;
      right: 440px;
      width: 200px;
      height: 120px;
      background: var(--bg-node);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      z-index: 10;
      transition: right 0.3s;
    }

    .minimap.sidebar-closed { right: 16px; }

    .minimap-viewport {
      position: absolute;
      border: 1px solid var(--accent-blue);
      background: rgba(74,125,255,0.05);
      border-radius: 2px;
      pointer-events: none;
    }

    .minimap-node {
      position: absolute;
      border-radius: 2px;
      background: var(--border-hover);
    }

    .minimap-node.selected { background: var(--accent-blue); }

    /* ═══ UPLOAD OVERLAY ═══ */
    .upload-overlay {
      position: fixed;
      inset: 0;
      background: rgba(10,10,15,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      backdrop-filter: blur(8px);
    }

    .upload-overlay.hidden { display: none; }

    .upload-box {
      text-align: center;
      padding: 60px;
    }

    .upload-icon {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    .upload-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .upload-sub {
      font-size: 13px;
      color: var(--text-dim);
      margin-bottom: 24px;
    }

    .upload-btn {
      padding: 12px 28px;
      border-radius: 8px;
      border: 1px solid var(--accent-blue);
      background: rgba(74,125,255,0.1);
      color: var(--accent-blue);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .upload-btn:hover { background: rgba(74,125,255,0.2); }

    .upload-or {
      margin: 16px 0;
      color: var(--text-dim);
      font-size: 12px;
    }

    .upload-demo {
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 3px;
      background: none;
      border: none;
      font-family: 'Space Grotesk', sans-serif;
    }

    .upload-demo:hover { color: var(--text-primary); }

    /* ═══ FLOW SELECTOR ═══ */
    .flow-nav {
      position: absolute;
      top: 52px;
      left: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 10;
    }

    .flow-nav-row {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .flow-nav-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-dim);
      padding: 0 4px;
    }

    .flow-tab {
      padding: 5px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-node);
      color: var(--text-secondary);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }

    .flow-tab:hover { background: var(--bg-node-hover); color: var(--text-primary); }

    .flow-tab.active {
      background: var(--accent-blue);
      color: white;
      border-color: var(--accent-blue);
    }

    .flow-tab.conditional {
      border-style: dashed;
    }

    .flow-tab.conditional.active {
      border-style: solid;
    }

    /* ═══ FLOW GROUP BOX ═══ */
    .flow-group-box {
      position: absolute;
      border: 1px dashed var(--border);
      border-radius: 16px;
      background: rgba(74,125,255,0.02);
      pointer-events: none;
    }

    .flow-group-label {
      position: absolute;
      top: -10px;
      left: 20px;
      padding: 2px 10px;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-dim);
      background: var(--bg-canvas);
      border-radius: 4px;
    }
  </style>
</head>
<body>

<div class="upload-overlay" id="uploadOverlay">
  <div class="upload-box">
    <div class="upload-icon">⬡</div>
    <div class="upload-text">Prompt Flow Viewer</div>
    <div class="upload-sub">Загрузите prompt-chain.json для визуализации</div>
    <label class="upload-btn">
      Выбрать файл
      <input type="file" accept=".json" style="display:none" onchange="handleFileUpload(event)" />
    </label>
    <div class="upload-or">или вставьте JSON</div>
    <textarea id="jsonInput" spellcheck="false" placeholder='{"$schema":"prompt-chain/v2", ...}' style="width:500px;max-width:90vw;height:180px;background:var(--bg-prompt);color:var(--text-primary);border:1px solid var(--border);border-radius:8px;padding:12px;font-family:'IBM Plex Mono',monospace;font-size:12px;resize:vertical;line-height:1.5;"></textarea>
    <div style="margin-top:10px;">
      <button class="upload-btn" onclick="loadFromTextarea()" style="padding:10px 24px;font-size:13px;">Загрузить JSON</button>
    </div>
    <div class="upload-or">или демо</div>
    <div>
      <button class="upload-demo" onclick="loadDemo('v1')">Демо v1 (single flow)</button>
      <span style="color:var(--text-dim);margin:0 4px;">|</span>
      <button class="upload-demo" onclick="loadDemo('v2')">Демо v2 (multi-flow Qforia)</button>
    </div>
  </div>
</div>

<div class="app" id="app" style="display:none;">

  <div class="canvas-wrap" id="canvasWrap">
    <div class="canvas" id="canvas">
      <div class="canvas-grid"></div>
      <svg class="edges-svg" id="edgesSvg"></svg>
    </div>

    <div class="toolbar">
      <button class="toolbar-btn" onclick="fitView()">⊞ Fit</button>
      <button class="toolbar-btn" onclick="zoomIn()">+ Zoom</button>
      <button class="toolbar-btn" onclick="zoomOut()">− Zoom</button>
      <button class="toolbar-btn" onclick="loadNewFile()">↑ Загрузить</button>
      <button class="theme-toggle" onclick="toggleTheme()" title="Тёмная / Светлая тема"></button>
    </div>

    <div class="flow-nav" id="flowNav" style="display:none;"></div>

    <div class="project-info" id="projectInfo">
      <div class="project-name" id="projectName"></div>
      <div class="project-stats" id="projectStats"></div>
    </div>

    <div class="minimap" id="minimap"></div>
  </div>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title" id="sidebarTitle">Выберите ноду</div>
      <button class="sidebar-close" onclick="closeSidebar()">✕</button>
    </div>
    <div class="sidebar-content" id="sidebarContent">
      <div style="color:var(--text-dim); font-size:13px; text-align:center; margin-top:40px;">
        Кликните на ноду, чтобы увидеть детали промпта
      </div>
    </div>
  </div>

</div>

<script>
let flowData = null;
let normalizedData = null;
let currentInstrumentIdx = 0;
let currentFlowIdx = 0;
let currentNodes = [];
let currentEdges = [];
let selectedNodeId = null;
let panX = 0, panY = 0, zoom = 1;
let isPanning = false, panStartX = 0, panStartY = 0;

function normalizeToV2(data) {
  if (data.$schema === 'prompt-chain/v2' && data.instruments) return data;
  return {
    $schema: 'prompt-chain/v2',
    meta: {
      ...data.meta,
      total_instruments: 1
    },
    instruments: [{
      id: 'instrument_1',
      name: data.meta.project || 'Main',
      description: data.meta.description || '',
      entry_file: data.meta.entry_file || '',
      variables: data.variables || {},
      flows: [{
        id: 'main',
        name: 'Основной поток',
        description: data.meta.description || '',
        default: true,
        condition: null,
        nodes: data.nodes || [],
        edges: data.edges || []
      }]
    }]
  };
}

function setCurrentFlow(instIdx, flowIdx) {
  currentInstrumentIdx = instIdx;
  currentFlowIdx = flowIdx;
  const inst = normalizedData.instruments[instIdx];
  const flow = inst.flows[flowIdx];
  currentNodes = flow.nodes;
  currentEdges = flow.edges;
}

const DEMO_DATA = {
  "$schema": "prompt-chain/v1",
  "meta": {
    "project": "company-rating-generator",
    "description": "Мультимодельный пайплайн поиска и рейтинга компаний по нише",
    "entry_file": "index.html",
    "analyzed_at": "2026-02-21T12:00:00Z",
    "total_steps": 8,
    "models_used": ["openai/gpt-4o", "google/gemini-2.0-flash-001", "anthropic/claude-sonnet-4", "x-ai/grok-3-mini-beta", "perplexity/sonar-pro"]
  },
  "variables": {
    "niche": { "source": "user_input", "element_id": "niche", "description": "Название ниши" },
    "geo": { "source": "user_input", "element_id": "geo", "description": "Гео (необязательно)" },
    "apiKey": { "source": "user_input", "element_id": "apiKey", "description": "API-ключ OpenRouter" }
  },
  "nodes": [
    {
      "id": "step_1", "label": "Список 30 компаний", "type": "llm_call", "execution": "parallel",
      "models": ["openai/gpt-4o", "google/gemini-2.0-flash-001", "anthropic/claude-sonnet-4"],
      "prompt_template": "Составь список 30 ${niche} в ${geo}",
      "prompt_raw": "Составь список 30 ${niche} в ${geo}",
      "inputs": ["niche", "geo"], "outputs": ["step1_responses"],
      "output_var": "conversations[model.id] → first assistant message",
      "description": "Параллельный запрос к 3 моделям: получить списки компаний",
      "position": { "x": 100, "y": 200 }
    },
    {
      "id": "step_2", "label": "Критерии оценки", "type": "llm_call", "execution": "parallel",
      "models": ["openai/gpt-4o", "google/gemini-2.0-flash-001", "anthropic/claude-sonnet-4"],
      "prompt_template": "Почему именно эти сервисы в ТОП? Критерии → группы → ранжирование по весу",
      "prompt_raw": "Почему именно эти сервисы были поставлены в ТОП.\n1. Составь список критериев, по которым ты оценивал сайты\n2. Разгруппируй эти критерии на смысловые группы\n3. Отранжируй эти критерии в порядке уменьшения веса влияния на место в рейтинге",
      "inputs": ["step_1"], "outputs": ["criteria_per_model"],
      "output_var": "conversations[model.id] → last assistant message",
      "description": "Follow-up: почему эти компании, по каким критериям",
      "position": { "x": 400, "y": 200 }
    },
    {
      "id": "step_3", "label": "Дедупликация критериев", "type": "llm_call", "execution": "sequential",
      "models": ["x-ai/grok-3-mini-beta"],
      "prompt_template": "Смысловая дедупликация критериев от 3 моделей → итоговая таблица",
      "prompt_raw": "Представь, что ты человек, который провел ресерч данной ниши и тебе необходимо составить собственный рейтинг...\n\nТебе необходимо выполнить смысловую дедупликацию критериев\nСоставить итоговую таблицу: критерий + методология оценки\n\nСписок критериев:\n<data>\n${criteriaBlocks}\n</data>",
      "inputs": ["step_2"], "outputs": ["grokCriteriaRaw"],
      "output_var": "grokCriteriaRaw",
      "description": "Grok объединяет критерии от 3 моделей в единую таблицу",
      "position": { "x": 700, "y": 100 }
    },
    {
      "id": "step_4", "label": "Аудитории и боли ЦА", "type": "llm_call", "execution": "sequential",
      "models": ["x-ai/grok-3-mini-beta"],
      "prompt_template": "4 сегмента ЦА × 15-20 болей/интентов + портреты",
      "prompt_raw": "Ты — маркетолог-аналитик и UX-специалист. Тебе дана ниша: \"${niche}\".\n\nСмоделируй 4 сегмента целевой аудитории для компаний в этой нише.\nДля каждого сегмента составь подробный список их болей, вопросов и интентов (не менее 15–20 пунктов).\n\nБЛОК 1 — markdown-таблица | ЦА | Боль / Интент |\nБЛОК 2 — портреты каждой ЦА",
      "inputs": ["niche"], "outputs": ["grokAudienceRaw"],
      "output_var": "grokAudienceRaw",
      "description": "Grok моделирует сегменты ЦА с болями и интентами",
      "position": { "x": 700, "y": 350 }
    },
    {
      "id": "step_5", "label": "XML-компилятор", "type": "llm_call", "execution": "sequential",
      "models": ["anthropic/claude-sonnet-4"],
      "prompt_template": "Критерии + аудитории → XML <criteria_structure> с groups, criteria, methodology",
      "prompt_raw": "Сейчас мы будем компилировать следующие данные:\n\n=== ИТОГОВЫЙ АНАЛИЗ КРИТЕРИЕВ ===\n${grokCriteriaRaw}\n\n=== АУДИТОРИИ И ИХ БОЛИ / ИНТЕНТЫ ===\n${grokAudienceRaw}\n\n...преобразовать в структурированный XML-формат...\n\n<criteria_structure>\n  <group name=\"...\">\n    <criterion name=\"...\">\n      <name>, <description>, <methodology>, <why_important>, <recommendation>, <target>, <example>\n    </criterion>\n  </group>\n</criteria_structure>",
      "inputs": ["step_3", "step_4"], "outputs": ["compilerRawXml"],
      "output_var": "compilerRawXml",
      "description": "Claude компилирует всё в структурированный XML",
      "position": { "x": 1050, "y": 220 }
    },
    {
      "id": "step_6", "label": "Генерация HTML-сайта", "type": "llm_call", "execution": "sequential",
      "models": ["anthropic/claude-sonnet-4"],
      "prompt_template": "SEO + дизайн-система + Schema.org → полный HTML рейтинг-портал",
      "prompt_raw": "РОЛЬ: Senior SEO-специалист, Frontend Designer-Engineer.\n\nДИЗАЙН-СИСТЕМА:\n- Типографика: expressive display + restrained body (запрет Inter/Roboto)\n- Цвета: CSS custom properties, доминант + акцент + нейтральная\n- Композиция: асимметрия, overlap, break the grid\n- Motion: CSS-first, sparse, high-impact\n\nСТРУКТУРА: Hero → Методология → Рейтинг (TOP-5 карточки + таблица 6+) → Аналитика → SEO-статья → FAQ → Футер\n\nВХОДНЫЕ ДАННЫЕ: ${compilerRawXml}",
      "inputs": ["step_5", "niche", "geo"], "outputs": ["canvasRawHtml"],
      "output_var": "canvasRawHtml",
      "description": "Claude генерирует полный HTML рейтинг-сайт с дизайн-системой",
      "position": { "x": 1400, "y": 80 }
    },
    {
      "id": "step_6_5", "label": "Поиск рейтингов", "type": "llm_call", "execution": "sequential",
      "models": ["perplexity/sonar-pro"],
      "prompt_template": "Найди 10-15 рейтингов по нише в рунете → JSON [{name, url}]",
      "prompt_raw": "Найди 10-15 лучших рейтингов и обзоров компаний по теме \"${niche}\" в русскоязычном интернете.\n\nВерни ТОЛЬКО JSON-массив:\n[{\"name\": \"Название рейтинга\", \"url\": \"https://...\"}]",
      "inputs": ["niche", "geo"], "outputs": ["extractedRatings", "downloadedRatings"],
      "output_var": "extractedRatings → downloadRatingSite() → downloadedRatings",
      "description": "Perplexity ищет рейтинги, затем скачиваются через CORS-прокси",
      "position": { "x": 1400, "y": 300 }
    },
    {
      "id": "step_7a", "label": "Извлечение компаний", "type": "llm_call", "execution": "sequential",
      "models": ["anthropic/claude-sonnet-4"],
      "prompt_template": "Извлечь уникальные компании + URL из ответов шага 1 → JSON",
      "prompt_raw": "Из текста ниже извлеки все уникальные компании.\nДля каждой определи URL основного сайта.\nОбъедини дубликаты.\n\nВерни JSON:\n[{\"name\": \"...\", \"url\": \"https://...\"}]\n\n${step1Responses}",
      "inputs": ["step_1"], "outputs": ["extractedCompanies", "downloadedSites"],
      "output_var": "extractedCompanies → downloadCompanySite() → downloadedSites",
      "description": "Claude парсит компании из ответов, сайты скачиваются через CORS-прокси",
      "position": { "x": 1400, "y": 520 }
    },
    {
      "id": "step_7b", "label": "Наполнение контентом", "type": "llm_call", "execution": "sequential",
      "trigger": "manual_button",
      "models": ["anthropic/claude-sonnet-4"],
      "prompt_template": "HTML-шаблон + рейтинги + сайты + данные пользователя → готовый сайт",
      "prompt_raw": "РОЛЬ: Senior SEO-копирайтер и веб-разработчик.\n\n1. HTML-ШАБЛОН: ${canvasRawHtml}\n2. ДАННЫЕ РЕЙТИНГОВ: ${ratingDataBlocks}\n3. ДАННЫЕ САЙТОВ: ${companyDataBlocks}\n4. КОМПАНИЯ ПОЛЬЗОВАТЕЛЯ: ${userCompanyData}\n5. XML-КРИТЕРИИ: ${compilerRawXml}\n\nНаполни шаблон реальными данными.\nКомпания пользователя — #1 с бейджем \"Выбор редакции\".",
      "inputs": ["step_6", "step_6_5", "step_7a", "step_5"],
      "outputs": ["canvasRawHtml_filled"],
      "output_var": "canvasRawHtml (overwritten)",
      "description": "Claude заполняет шаблон реальными данными компаний",
      "position": { "x": 1750, "y": 300 }
    }
  ],
  "edges": [
    { "from": "step_1", "to": "step_2", "label": "conversations (контекст чата)", "type": "context" },
    { "from": "step_2", "to": "step_3", "label": "criteriaBlocks", "type": "data" },
    { "from": "step_3", "to": "step_5", "label": "grokCriteriaRaw", "type": "data" },
    { "from": "step_4", "to": "step_5", "label": "grokAudienceRaw", "type": "data" },
    { "from": "step_5", "to": "step_6", "label": "compilerRawXml", "type": "data" },
    { "from": "step_5", "to": "step_7b", "label": "compilerRawXml", "type": "data" },
    { "from": "step_6", "to": "step_7b", "label": "canvasRawHtml", "type": "data" },
    { "from": "step_6_5", "to": "step_7b", "label": "downloadedRatings", "type": "data" },
    { "from": "step_1", "to": "step_7a", "label": "step1Responses", "type": "data" },
    { "from": "step_7a", "to": "step_7b", "label": "downloadedSites", "type": "data" }
  ]
};

const DEMO_DATA_V2 = {"$schema":"prompt-chain/v2","meta":{"project":"qforia-extended","description":"Мультирежимный аналитик запросов: глубокий анализ, покрытие, инжиниринг, сигналы","analyzed_at":"2026-02-21T14:00:00Z","total_instruments":1,"total_steps":12,"models_used":["openai/gpt-4o","anthropic/claude-sonnet-4","google/gemini-2.0-flash-001","x-ai/grok-3-mini-beta","perplexity/sonar-pro"]},"instruments":[{"id":"query_analyzer","name":"Query Analyzer","description":"Анализ поисковых запросов в 4 режимах","entry_file":"src/app/api/fanout/route.ts","variables":{"query":{"source":"user_input","description":"Поисковый запрос"},"url":{"source":"user_input","description":"URL страницы"},"mode":{"source":"user_input","description":"Режим анализа"}},"flows":[{"id":"deep_analysis","name":"Глубокий анализ","description":"Fan-Out → Merge → Аудит ЦА → 4 компиляции","default":true,"condition":null,"nodes":[{"id":"step_1","label":"Fan-Out: Анализ запроса","type":"llm_call","execution":"parallel","trigger":"auto","models":["openai/gpt-4o","anthropic/claude-sonnet-4","google/gemini-2.0-flash-001"],"prompt_template":"Глубокий анализ запроса: интент, субинтенты, ЦА","prompt_raw":"Ты — SEO-аналитик. Проведи глубокий анализ запроса \"${query}\".","inputs":["query"],"outputs":["fan_out_responses"],"output_var":"fanOutResponses[modelId]","description":"Параллельный запрос к 3 моделям","position":{"x":100,"y":200}},{"id":"step_2","label":"Merge: Объединение","type":"llm_call","execution":"sequential","trigger":"auto","models":["x-ai/grok-3-mini-beta"],"prompt_template":"Дедупликация и объединение 3 анализов","prompt_raw":"Объедини 3 анализа запроса \"${query}\".","inputs":["step_1"],"outputs":["merged_analysis"],"output_var":"mergedAnalysis","description":"Grok объединяет 3 анализа","position":{"x":450,"y":200}},{"id":"step_3","label":"Аудит ЦА и болей","type":"llm_call","execution":"sequential","trigger":"auto","models":["x-ai/grok-3-mini-beta"],"prompt_template":"4 сегмента ЦА × боли × интенты","prompt_raw":"Проведи расширенный аудит ЦА на основе ${mergedAnalysis}.","inputs":["step_2"],"outputs":["audience_audit"],"output_var":"audienceAudit","description":"Аудит целевой аудитории","position":{"x":800,"y":200}},{"id":"step_4","label":"Web-ресерч (Perplexity)","type":"llm_call","execution":"parallel","trigger":"auto","models":["perplexity/sonar-pro"],"prompt_template":"ТОП-10 статей по запросу","prompt_raw":"Найди 10 лучших статей по \"${query}\".","inputs":["query"],"outputs":["web_research"],"output_var":"webResearch","description":"Perplexity ищет статьи параллельно","shared":true,"position":{"x":450,"y":450}},{"id":"step_5","label":"SEO-структура","type":"llm_call","execution":"parallel","trigger":"auto","models":["anthropic/claude-sonnet-4"],"prompt_template":"Анализ + аудит → структура SEO-статьи","prompt_raw":"Составь структуру SEO-статьи.","inputs":["step_3","step_2"],"outputs":["seo_structure"],"output_var":"seoStructure","description":"Claude компилирует SEO-структуру","position":{"x":1150,"y":50}},{"id":"step_6","label":"Контент-план","type":"llm_call","execution":"parallel","trigger":"auto","models":["anthropic/claude-sonnet-4"],"prompt_template":"Анализ + аудит → контент-план","prompt_raw":"Создай контент-план по кластерам.","inputs":["step_3","step_2"],"outputs":["content_plan"],"output_var":"contentPlan","description":"Claude составляет контент-план","position":{"x":1150,"y":200}},{"id":"step_7","label":"Рекомендации","type":"llm_call","execution":"parallel","trigger":"auto","models":["openai/gpt-4o"],"prompt_template":"Анализ + веб-ресерч → рекомендации","prompt_raw":"Составь тактические рекомендации.","inputs":["step_2","step_4"],"outputs":["recommendations"],"output_var":"recommendations","description":"GPT-4o формирует рекомендации","position":{"x":1150,"y":350}},{"id":"step_8","label":"Итоговый отчёт","type":"llm_call","execution":"parallel","trigger":"auto","models":["google/gemini-2.0-flash-001"],"prompt_template":"Все данные → финальный отчёт","prompt_raw":"Собери финальный отчёт.","inputs":["step_5","step_6","step_7","step_3"],"outputs":["final_report"],"output_var":"finalReport","description":"Gemini собирает финальный отчёт","position":{"x":1500,"y":200}}],"edges":[{"from":"step_1","to":"step_2","label":"fanOutResponses","type":"data"},{"from":"step_2","to":"step_3","label":"mergedAnalysis","type":"data"},{"from":"step_3","to":"step_5","label":"audienceAudit","type":"data"},{"from":"step_2","to":"step_5","label":"mergedAnalysis","type":"data"},{"from":"step_3","to":"step_6","label":"audienceAudit","type":"data"},{"from":"step_2","to":"step_6","label":"mergedAnalysis","type":"data"},{"from":"step_2","to":"step_7","label":"mergedAnalysis","type":"data"},{"from":"step_4","to":"step_7","label":"webResearch","type":"data"},{"from":"step_5","to":"step_8","label":"seoStructure","type":"data"},{"from":"step_6","to":"step_8","label":"contentPlan","type":"data"},{"from":"step_7","to":"step_8","label":"recommendations","type":"data"},{"from":"step_3","to":"step_8","label":"audienceAudit","type":"data"}]},{"id":"coverage","name":"Покрытие субинтентов","description":"Анализ покрытия страницы","default":false,"condition":"mode === 'Покрытие субинтентов'","nodes":[{"id":"step_9","label":"Анализ покрытия","type":"llm_call","execution":"sequential","trigger":"conditional","condition":"mode === 'Покрытие субинтентов'","models":["anthropic/claude-sonnet-4"],"prompt_template":"URL + запрос → матрица покрытия","prompt_raw":"Проведи анализ покрытия страницы ${url} по запросу \"${query}\".","inputs":["query","url"],"outputs":["coverage_matrix"],"output_var":"coverageMatrix","description":"Claude анализирует покрытие субинтентов","position":{"x":100,"y":200}}],"edges":[]},{"id":"grounding","name":"Инжиниринг промптов","description":"SEO-промпты на основе конкурентов","default":false,"condition":"mode === 'Инжиниринг'","nodes":[{"id":"step_10a","label":"Скачивание конкурентов","type":"web_fetch","execution":"parallel","trigger":"conditional","condition":"mode === 'Инжиниринг'","models":[],"prompt_template":"Скачать ТОП-10 из SERP","prompt_raw":"fetch(url)","inputs":["query"],"outputs":["competitor_pages"],"output_var":"competitorPages[]","description":"Скачивание ТОП-10 страниц","position":{"x":100,"y":100}},{"id":"step_10b","label":"SERP-контекст","type":"llm_call","execution":"parallel","trigger":"conditional","condition":"mode === 'Инжиниринг'","models":["perplexity/sonar-pro"],"prompt_template":"Контекст выдачи по запросу","prompt_raw":"Проанализируй SERP по \"${query}\".","inputs":["query"],"outputs":["serp_context"],"output_var":"serpContext","description":"Perplexity: мета-информация о выдаче","position":{"x":100,"y":350}},{"id":"step_11","label":"Генерация SEO-промптов","type":"llm_call","execution":"sequential","trigger":"auto","models":["anthropic/claude-sonnet-4"],"prompt_template":"Конкуренты + SERP → промпты","prompt_raw":"Сгенерируй SEO-промпты на основе ${competitorPages} и ${serpContext}.","inputs":["step_10a","step_10b"],"outputs":["seo_prompts"],"output_var":"seoPrompts","description":"Claude генерирует оптимизированные промпты","position":{"x":500,"y":200}}],"edges":[{"from":"step_10a","to":"step_11","label":"competitorPages","type":"data"},{"from":"step_10b","to":"step_11","label":"serpContext","type":"data"}]},{"id":"signals","name":"Сигналы","description":"Мониторинг SEO-сигналов","default":false,"condition":"mode === 'Сигналы'","nodes":[{"id":"step_12","label":"Анализ SEO-сигналов","type":"llm_call","execution":"sequential","trigger":"conditional","condition":"mode === 'Сигналы'","models":["openai/gpt-4o"],"prompt_template":"Диагностика SEO-сигналов","prompt_raw":"Проведи диагностику SEO-сигналов для ${url} по запросу \"${query}\".","inputs":["query","url"],"outputs":["signal_report"],"output_var":"signalReport","description":"GPT-4o диагностирует SEO-сигналы","position":{"x":100,"y":200}}],"edges":[]}]}]};

function handleFileUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const data = JSON.parse(ev.target.result);
      initFlow(data);
    } catch (err) {
      alert('Ошибка парсинга JSON: ' + err.message);
    }
  };
  reader.readAsText(file);
}

function loadDemo(version) {
  if (version === 'v2') { initFlow(DEMO_DATA_V2); }
  else { initFlow(DEMO_DATA); }
}

function loadFromTextarea() {
  const raw = document.getElementById('jsonInput').value.trim();
  if (!raw) { alert('Вставьте JSON в поле'); return; }
  try {
    const data = JSON.parse(raw);
    initFlow(data);
  } catch (err) {
    alert('Ошибка парсинга JSON: ' + err.message);
  }
}

function loadNewFile() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = handleFileUpload;
  input.click();
}

function initFlow(data) {
  flowData = data;
  normalizedData = normalizeToV2(data);
  selectedNodeId = null;

  document.getElementById('uploadOverlay').classList.add('hidden');
  document.getElementById('app').style.display = 'flex';

  document.getElementById('projectName').textContent = normalizedData.meta.project;
  const totalFlows = normalizedData.instruments.reduce((s, i) => s + i.flows.length, 0);
  document.getElementById('projectStats').textContent =
    `${normalizedData.meta.total_instruments || normalizedData.instruments.length} инструм. · ${totalFlows} потоков · ${normalizedData.meta.total_steps} шагов · ${normalizedData.meta.models_used.length} моделей`;

  const defaultInstIdx = 0;
  const defaultFlowIdx = normalizedData.instruments[0].flows.findIndex(f => f.default) || 0;
  setCurrentFlow(defaultInstIdx, Math.max(0, defaultFlowIdx));

  renderFlowNav();
  renderNodes();
  renderEdges();
  renderMinimap();
  fitView();
  resetSidebar();
}

function renderFlowNav() {
  const nav = document.getElementById('flowNav');
  if (normalizedData.instruments.length <= 1 && normalizedData.instruments[0].flows.length <= 1) {
    nav.style.display = 'none';
    return;
  }
  nav.style.display = 'flex';
  let html = '';

  normalizedData.instruments.forEach((inst, iIdx) => {
    if (normalizedData.instruments.length > 1) {
      html += `<div class="flow-nav-label">${inst.name}</div>`;
    }
    html += '<div class="flow-nav-row">';
    inst.flows.forEach((flow, fIdx) => {
      const active = iIdx === currentInstrumentIdx && fIdx === currentFlowIdx ? ' active' : '';
      const cond = flow.condition ? ' conditional' : '';
      const title = flow.condition ? `if ${flow.condition}` : '';
      html += `<button class="flow-tab${active}${cond}" title="${title}" onclick="switchFlow(${iIdx},${fIdx})">${flow.name}</button>`;
    });
    html += '</div>';
  });

  nav.innerHTML = html;
}

function switchFlow(instIdx, flowIdx) {
  setCurrentFlow(instIdx, flowIdx);
  selectedNodeId = null;
  renderFlowNav();
  renderNodes();
  renderEdges();
  renderMinimap();
  fitView();
  resetSidebar();
}

function renderNodes() {
  const canvas = document.getElementById('canvas');
  canvas.querySelectorAll('.node').forEach(el => el.remove());
  canvas.querySelectorAll('.flow-group-box').forEach(el => el.remove());

  for (const node of currentNodes) {
    const el = document.createElement('div');
    el.className = 'node';
    el.id = `node-${node.id}`;
    el.style.left = (node.position.x + 5000) + 'px';
    el.style.top = (node.position.y + 5000) + 'px';

    const iconClass = node.type === 'llm_call' ? 'llm' : node.type === 'web_fetch' ? 'web' : node.type === 'data_transform' ? 'transform' : node.type === 'router' ? 'router' : node.type === 'conditional' ? 'conditional' : 'input';
    const iconSymbol = node.type === 'llm_call' ? 'AI' : node.type === 'web_fetch' ? '↓' : node.type === 'router' ? '⑂' : node.type === 'conditional' ? '?' : '⚙';

    const badgeClass = node.trigger === 'manual_button' ? 'badge-manual' : node.execution === 'parallel' ? 'badge-parallel' : 'badge-sequential';
    const badgeText = node.trigger === 'manual_button' ? 'manual' : node.execution;

    const modelText = (node.models || []).map(m => m.split('/').pop()).join(', ');

    el.innerHTML = `
      <div class="node-connector input-conn"></div>
      <div class="node-connector output-conn"></div>
      <div class="node-header">
        <div class="node-icon ${iconClass}">${iconSymbol}</div>
        <div class="node-title">${node.label}</div>
      </div>
      <div class="node-body">
        <div class="node-model">${modelText}</div>
        <div class="node-desc">${node.description}</div>
        <span class="node-badge ${badgeClass}">${badgeText}</span>
      </div>`;

    el.addEventListener('click', (e) => {
      e.stopPropagation();
      selectNode(node.id);
    });

    canvas.appendChild(el);
  }
}

function renderEdges() {
  const svg = document.getElementById('edgesSvg');
  svg.innerHTML = '';

  for (const edge of currentEdges) {
    const fromNode = currentNodes.find(n => n.id === edge.from);
    const toNode = currentNodes.find(n => n.id === edge.to);
    if (!fromNode || !toNode) continue;

    const x1 = fromNode.position.x + 240 + 5000;
    const y1 = fromNode.position.y + 50 + 5000;
    const x2 = toNode.position.x + 5000;
    const y2 = toNode.position.y + 50 + 5000;

    const midX = (x1 + x2) / 2;

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', `M ${x1} ${y1} C ${midX} ${y1}, ${midX} ${y2}, ${x2} ${y2}`);
    path.setAttribute('class', 'edge-path');
    path.dataset.from = edge.from;
    path.dataset.to = edge.to;
    svg.appendChild(path);

    const labelX = midX;
    const labelY = (y1 + y2) / 2 - 8;
    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    text.setAttribute('x', labelX);
    text.setAttribute('y', labelY);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('class', 'edge-label');
    text.dataset.from = edge.from;
    text.dataset.to = edge.to;
    text.textContent = edge.label;
    svg.appendChild(text);
  }
}

function selectNode(nodeId) {
  selectedNodeId = nodeId;

  document.querySelectorAll('.node').forEach(el => el.classList.remove('selected'));
  const nodeEl = document.getElementById(`node-${nodeId}`);
  if (nodeEl) nodeEl.classList.add('selected');

  document.querySelectorAll('.edge-path').forEach(el => {
    el.classList.toggle('active', el.dataset.from === nodeId || el.dataset.to === nodeId);
  });
  document.querySelectorAll('.edge-label').forEach(el => {
    el.classList.toggle('active', el.dataset.from === nodeId || el.dataset.to === nodeId);
  });

  const node = currentNodes.find(n => n.id === nodeId);
  if (!node) return;

  document.getElementById('sidebarTitle').textContent = node.label;

  const sidebar = document.getElementById('sidebar');
  sidebar.classList.remove('collapsed');
  updateSidebarOffsets();

  const promptHighlighted = (node.prompt_raw || '').replace(/\$\{(\w+)\}/g, '<span class="prompt-var">${$1}</span>');

  const inputItems = (node.inputs || []).map(inp => {
    const isNode = currentNodes.find(n => n.id === inp);
    return `<div class="io-item"><span class="io-dot in"></span>${isNode ? isNode.label : inp}</div>`;
  }).join('');

  const outputItems = (node.outputs || []).map(out =>
    `<div class="io-item"><span class="io-dot out"></span>${out}</div>`
  ).join('');

  const currentFlow = normalizedData.instruments[currentInstrumentIdx].flows[currentFlowIdx];
  const flowInfo = currentFlow.condition
    ? `${currentFlow.name} <span style="color:var(--accent-orange);font-size:11px;">(${currentFlow.condition})</span>`
    : currentFlow.name;

  document.getElementById('sidebarContent').innerHTML = `
    <div class="detail-section">
      <div class="detail-label">Поток</div>
      <div class="detail-value">${flowInfo}</div>
    </div>

    <div class="detail-section">
      <div class="detail-label">Описание</div>
      <div class="detail-value">${node.description}</div>
    </div>

    <div class="detail-section">
      <div class="detail-label">Модели</div>
      <div class="detail-models">
        ${(node.models || []).map(m => `<span class="model-tag">${m}</span>`).join('')}
      </div>
    </div>

    <div class="detail-section">
      <div class="detail-label">Выполнение</div>
      <div class="detail-value">${node.execution}${node.trigger === 'manual_button' ? ' (по кнопке)' : ''}</div>
    </div>

    <div class="detail-section">
      <div class="detail-label">Входы</div>
      <div class="io-list">${inputItems || '<div class="io-item" style="color:var(--text-dim)">нет</div>'}</div>
    </div>

    <div class="detail-section">
      <div class="detail-label">Выходы</div>
      <div class="io-list">${outputItems || '<div class="io-item" style="color:var(--text-dim)">нет</div>'}</div>
    </div>

    <div class="detail-section">
      <div class="detail-label">Переменная результата</div>
      <div class="detail-value" style="font-family:'IBM Plex Mono',monospace; font-size:12px; color:var(--accent-orange);">${node.output_var || '—'}</div>
    </div>

    <div class="detail-section">
      <div class="detail-label">Краткий промпт</div>
      <div class="detail-value" style="font-style:italic; color:var(--text-secondary);">${node.prompt_template || '—'}</div>
    </div>

    <div class="detail-section">
      <div class="detail-label">Полный промпт</div>
      <div class="prompt-block">
        <button class="copy-prompt-btn" onclick="copyPrompt()">Copy</button>
        ${promptHighlighted}
      </div>
    </div>`;

  renderMinimap();
}

function copyPrompt() {
  const node = currentNodes.find(n => n.id === selectedNodeId);
  if (node) {
    navigator.clipboard.writeText(node.prompt_raw).then(() => {
      const btn = document.querySelector('.copy-prompt-btn');
      if (btn) { btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy', 1500); }
    });
  }
}

function resetSidebar() {
  document.getElementById('sidebarTitle').textContent = 'Выберите ноду';
  document.getElementById('sidebarContent').innerHTML = `
    <div style="color:var(--text-dim); font-size:13px; text-align:center; margin-top:40px;">
      Кликните на ноду, чтобы увидеть детали промпта
    </div>`;
}

function closeSidebar() {
  document.getElementById('sidebar').classList.add('collapsed');
  updateSidebarOffsets();
}

function updateSidebarOffsets() {
  const collapsed = document.getElementById('sidebar').classList.contains('collapsed');
  document.getElementById('projectInfo').classList.toggle('sidebar-closed', collapsed);
  document.getElementById('minimap').classList.toggle('sidebar-closed', collapsed);
}

function renderMinimap() {
  if (!currentNodes.length) return;
  const minimap = document.getElementById('minimap');
  const mmW = 200, mmH = 120;

  const xs = currentNodes.map(n => n.position.x);
  const ys = currentNodes.map(n => n.position.y);
  const minX = Math.min(...xs) - 50;
  const minY = Math.min(...ys) - 50;
  const maxX = Math.max(...xs) + 290;
  const maxY = Math.max(...ys) + 150;
  const rangeX = maxX - minX || 1;
  const rangeY = maxY - minY || 1;
  const scale = Math.min(mmW / rangeX, mmH / rangeY);

  let html = '';
  for (const node of currentNodes) {
    const x = (node.position.x - minX) * scale;
    const y = (node.position.y - minY) * scale;
    const w = 240 * scale;
    const h = 30 * scale;
    const sel = node.id === selectedNodeId ? ' selected' : '';
    html += `<div class="minimap-node${sel}" style="left:${x}px;top:${y}px;width:${w}px;height:${h}px;"></div>`;
  }
  minimap.innerHTML = html;
}

// ═══ PAN & ZOOM ═══
const canvasWrap = document.getElementById('canvasWrap');
const canvas = document.getElementById('canvas');

canvasWrap.addEventListener('mousedown', (e) => {
  if (e.target.closest('.node')) return;
  isPanning = true;
  panStartX = e.clientX - panX;
  panStartY = e.clientY - panY;
  canvasWrap.classList.add('grabbing');
});

window.addEventListener('mousemove', (e) => {
  if (!isPanning) return;
  panX = e.clientX - panStartX;
  panY = e.clientY - panStartY;
  updateTransform();
});

window.addEventListener('mouseup', () => {
  isPanning = false;
  canvasWrap.classList.remove('grabbing');
});

canvasWrap.addEventListener('wheel', (e) => {
  e.preventDefault();
  const rect = canvasWrap.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  const prevZoom = zoom;
  zoom *= e.deltaY > 0 ? 0.92 : 1.08;
  zoom = Math.max(0.15, Math.min(3, zoom));

  panX = mx - (mx - panX) * (zoom / prevZoom);
  panY = my - (my - panY) * (zoom / prevZoom);
  updateTransform();
}, { passive: false });

canvasWrap.addEventListener('click', (e) => {
  if (!e.target.closest('.node')) {
    selectedNodeId = null;
    document.querySelectorAll('.node').forEach(el => el.classList.remove('selected'));
    document.querySelectorAll('.edge-path').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.edge-label').forEach(el => el.classList.remove('active'));
    resetSidebar();
    renderMinimap();
  }
});

function updateTransform() {
  canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`;
}

function fitView() {
  if (!currentNodes.length) return;
  const rect = canvasWrap.getBoundingClientRect();
  const xs = currentNodes.map(n => n.position.x + 5000);
  const ys = currentNodes.map(n => n.position.y + 5000);
  const minX = Math.min(...xs) - 60;
  const minY = Math.min(...ys) - 60;
  const maxX = Math.max(...xs) + 300;
  const maxY = Math.max(...ys) + 160;

  const w = maxX - minX;
  const h = maxY - minY;
  zoom = Math.min(rect.width / w, rect.height / h) * 0.85;
  zoom = Math.max(0.2, Math.min(2, zoom));

  panX = (rect.width - w * zoom) / 2 - minX * zoom;
  panY = (rect.height - h * zoom) / 2 - minY * zoom;
  updateTransform();
}

function zoomIn() { zoom = Math.min(3, zoom * 1.2); updateTransform(); }
function zoomOut() { zoom = Math.max(0.15, zoom * 0.8); updateTransform(); }

function toggleTheme() {
  const html = document.documentElement;
  const current = html.getAttribute('data-theme');
  const next = current === 'light' ? 'dark' : 'light';
  html.setAttribute('data-theme', next === 'dark' ? '' : next);
  if (next === 'dark') html.removeAttribute('data-theme');
}
</script>
</body>
</html>
